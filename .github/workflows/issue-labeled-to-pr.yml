name: Sync Issue labels to PR

on:
  issues:
    types: [labeled, unlabeled]

permissions:
  issues: read
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const label = context.payload.label;
            const q = `repo:${context.repo.owner}/${context.repo.repo} "Related-Issue: #${issue.number}" in:body`;
            const res = await github.rest.search.issuesAndPullRequests({ q });
            for (const item of res.data.items) {
              if (!item.pull_request) continue;
              const prNumber = item.number;
              if (context.payload.action === 'labeled') {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: [label.name]
                });
              } else {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                }).catch(()=>{});
              }
            }
