name: Create Issue from PR

on:
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  create-issue:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PAT_FOR_API: ${{ secrets.PAT_FOR_API }}
    steps:
      - name: Create GitHub Issue for PR and annotate PR (GITHUB_TOKEN)
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = `[PR ${pr.number}] ${pr.title}`;
            const body = `Auto-created ticket for PR #${pr.number}\n\nPR: ${pr.html_url}\n\n*Track work and status here.*`;
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['triage']
            });

            // Comment and update PR body with Related-Issue reference
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `Related-Issue: #${issue.data.number}`
            });

            const newBody = `${pr.body || ''}\n\nRelated-Issue: #${issue.data.number}`.trim();
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });

            // Label the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ticket-created']
            });

      - name: Add Issue to GitHub Project (requires PAT_FOR_API)
        if: ${{ github.event.pull_request.head.repo.fork == false && env.PROJECT_ID != '' && env.PAT_FOR_API != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.PAT_FOR_API }}
          script: |
            const pr = context.payload.pull_request;
            // Find the Related-Issue reference from the PR body comment we added in previous step
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            const body = prData.body || '';
            const m = body.match(/Related-Issue:\s*#(\d+)/i);
            if (!m) {
              core.warning('No Related-Issue reference found on PR body. Skipping project add.');
              return;
            }
            const issueNumber = Number(m[1]);

            // Get node id for the issue
            const nodeQuery = await github.graphql(`
              query($owner:String!, $repo:String!, $number:Int!){
                repository(owner:$owner, name:$repo){ issue(number:$number){ id } }
              }
            `, { owner: context.repo.owner, repo: context.repo.repo, number: issueNumber });
            const issueNodeId = nodeQuery.repository.issue.id;

            // Add to Project V2
            const projectId = process.env.PROJECT_ID;
            await github.graphql(`
              mutation($projectId:ID!, $contentId:ID!){
                addProjectV2ItemById(input:{ projectId:$projectId, contentId:$contentId }){ item { id } }
              }
            `, { projectId, contentId: issueNodeId });
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
