name: Community Automation

on:
  pull_request:
    types: [opened]
  issues:
    types: [labeled, unlabeled]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  create-issue-from-pr:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PAT_FOR_API: ${{ secrets.PAT_FOR_API }}
    steps:
      - name: Create GitHub Issue for PR and annotate PR (GITHUB_TOKEN)
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        uses: actions/github-script@v7
        id: create
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = `[PR ${pr.number}] ${pr.title}`;
            const body = `Auto-created ticket for PR #${pr.number}\n\nPR: ${pr.html_url}\n\n*Track work and status here.*`;
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['triage']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `Related-Issue: #${issue.data.number}`
            });

            const newBody = `${pr.body || ''}\n\nRelated-Issue: #${issue.data.number}`.trim();
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ticket-created']
            });

            core.setOutput('issue_number', issue.data.number);

      - name: Add Issue to GitHub Project (requires PAT_FOR_API)
        if: ${{ github.event.pull_request.head.repo.fork == false && env.PROJECT_ID != '' && env.PAT_FOR_API != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.PAT_FOR_API }}
          script: |
            const issueNumber = Number(process.env.INPUT_ISSUE_NUMBER || '${{ steps.create.outputs.issue_number }}');
            if (!issueNumber) {
              core.warning('No issue number found from previous step. Skipping project add.');
              return;
            }

            const nodeQuery = await github.graphql(`
              query($owner:String!, $repo:String!, $number:Int!){
                repository(owner:$owner, name:$repo){ issue(number:$number){ id } }
              }
            `, { owner: context.repo.owner, repo: context.repo.repo, number: issueNumber });
            const issueNodeId = nodeQuery.repository.issue.id;

            const projectId = process.env.PROJECT_ID;
            await github.graphql(`
              mutation($projectId:ID!, $contentId:ID!){
                addProjectV2ItemById(input:{ projectId:$projectId, contentId:$contentId }){ item { id } }
              }
            `, { projectId, contentId: issueNodeId });
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          INPUT_ISSUE_NUMBER: ${{ steps.create.outputs.issue_number }}

  sync-issue-labels-to-pr:
    if: github.event_name == 'issues' && (github.event.action == 'labeled' || github.event.action == 'unlabeled')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const label = context.payload.label;
            const q = `repo:${context.repo.owner}/${context.repo.repo} "Related-Issue: #${issue.number}" in:body`;
            const res = await github.rest.search.issuesAndPullRequests({ q });
            for (const item of res.data.items) {
              if (!item.pull_request) continue;
              const prNumber = item.number;
              if (context.payload.action === 'labeled') {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: [label.name]
                });
              } else {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                }).catch(()=>{});
              }
            }
